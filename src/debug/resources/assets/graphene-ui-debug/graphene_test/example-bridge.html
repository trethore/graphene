<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <title>Graphene Bridge Example</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 16px;
            line-height: 1.4;
        }

        .row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        input, button {
            font: inherit;
            padding: 6px 8px;
        }

        input[type="text"], input[type="number"] {
            min-width: 220px;
        }

        #bridge-status {
            font-weight: 700;
            margin: 8px 0 16px;
        }

        #devtools-message {
            padding: 10px;
            border: 1px solid #999;
            border-radius: 6px;
            margin-bottom: 16px;
            background: #f5f5f5;
            min-height: 22px;
        }

        pre {
            background: #111;
            color: #eee;
            padding: 10px;
            border-radius: 6px;
            overflow: auto;
            max-height: 220px;
        }
    </style>
</head>
<body>
<h1>Bridge Example</h1>
<p><a href="welcome.html">Back to welcome page</a></p>

<div id="bridge-status">Bridge status: connecting...</div>
<div id="devtools-message">Open the DevTools button in the debug screen to receive a Java -> JS message.</div>

<h2>JS -> Java Event</h2>
<div class="row">
    <label for="event-text">Event text</label>
    <input id="event-text" placeholder="Type a text message" type="text" value="Hello from JS event">
    <button id="send-event" type="button">Send debug:event</button>
</div>

<h2>JS -> Java Request (Echo)</h2>
<div class="row">
    <label for="echo-text">Echo text</label>
    <input id="echo-text" placeholder="Text to echo" type="text" value="Hello from JS request">
    <button id="send-echo" type="button">Send debug:echo</button>
</div>

<h2>JS -> Java Request (Sum)</h2>
<div class="row">
    <label for="sum-a">A</label>
    <input id="sum-a" step="any" type="number" value="5">
    <label for="sum-b">B</label>
    <input id="sum-b" step="any" type="number" value="7">
    <button id="send-sum" type="button">Send debug:sum</button>
</div>

<h2>Result</h2>
<pre id="response-log">No messages yet.</pre>

<script>
    let bridge = null;

    function bridgeStatusElement() {
        return document.getElementById("bridge-status");
    }

    function devToolsMessageElement() {
        return document.getElementById("devtools-message");
    }

    function responseLogElement() {
        return document.getElementById("response-log");
    }

    function setBridgeStatus(text) {
        bridgeStatusElement().textContent = text;
    }

    function appendLogLine(label, value) {
        const log = responseLogElement();
        const rendered = typeof value === "string" ? value : JSON.stringify(value, null, 2);
        log.textContent = "[" + new Date().toISOString() + "] " + label + "\n" + rendered + "\n\n" + log.textContent;
    }

    function requireBridge() {
        if (!bridge) {
            appendLogLine("Bridge", "Bridge is not ready yet.");
            return null;
        }

        return bridge;
    }

    function onDevToolsStatus(payload) {
        const opened = Boolean(payload && payload.opened);
        const port = payload && payload.debugPort ? payload.debugPort : "unknown";
        if (opened) {
            devToolsMessageElement().textContent = "DevTools opened from Java on port " + port + ". Java -> JS event received.";
            appendLogLine("Java -> JS event", payload);
            return;
        }

        devToolsMessageElement().textContent = "DevTools open attempted but remote debugging is unavailable.";
        appendLogLine("Java -> JS event", payload);
    }

    function connectBridgeWhenAvailable() {
        const candidate = globalThis.grapheneBridge;
        if (!candidate || typeof candidate.emit !== "function" || typeof candidate.request !== "function") {
            setTimeout(connectBridgeWhenAvailable, 50);
            return;
        }

        bridge = candidate;
        setBridgeStatus("Bridge status: connected");
        bridge.on("debug:devtools-status", onDevToolsStatus);
        appendLogLine("Bridge", "Connected and listener registered.");
    }

    function sendEventToJava() {
        const currentBridge = requireBridge();
        if (!currentBridge) {
            return;
        }

        const payload = {
            text: document.getElementById("event-text").value,
            sentAt: new Date().toISOString(),
            page: "example-bridge"
        };

        currentBridge.emit("debug:event", payload)
            .then(function () {
                appendLogLine("JS -> Java event", payload);
            })
            .catch(function (error) {
                appendLogLine("JS -> Java event error", error && error.message ? error.message : String(error));
            });
    }

    function sendEchoRequest() {
        const currentBridge = requireBridge();
        if (!currentBridge) {
            return;
        }

        const payload = {
            text: document.getElementById("echo-text").value,
            sentAt: new Date().toISOString()
        };

        currentBridge.request("debug:echo", payload)
            .then(function (responsePayload) {
                appendLogLine("JS -> Java request debug:echo", responsePayload);
            })
            .catch(function (error) {
                appendLogLine("JS -> Java request error", error && error.message ? error.message : String(error));
            });
    }

    function sendSumRequest() {
        const currentBridge = requireBridge();
        if (!currentBridge) {
            return;
        }

        const left = Number(document.getElementById("sum-a").value);
        const right = Number(document.getElementById("sum-b").value);
        const payload = {a: left, b: right};

        currentBridge.request("debug:sum", payload)
            .then(function (responsePayload) {
                appendLogLine("JS -> Java request debug:sum", responsePayload);
            })
            .catch(function (error) {
                appendLogLine("JS -> Java request error", error && error.message ? error.message : String(error));
            });
    }

    function installHandlers() {
        document.getElementById("send-event").addEventListener("click", sendEventToJava);
        document.getElementById("send-echo").addEventListener("click", sendEchoRequest);
        document.getElementById("send-sum").addEventListener("click", sendSumRequest);
    }

    installHandlers();
    connectBridgeWhenAvailable();
</script>
</body>
</html>
