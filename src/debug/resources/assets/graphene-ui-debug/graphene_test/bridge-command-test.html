<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <title>Graphene Bridge Command Test</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 16px;
            line-height: 1.4;
        }

        #side-button-status {
            margin-top: 12px;
            padding: 10px;
            border: 1px solid #888;
            border-radius: 6px;
            background: #f5f5f5;
        }
    </style>
</head>
<body>
<h1>Bridge Command Test</h1>
<div id="side-button-status">Side button status: waiting for grapheneMouse...</div>

<script>
    const CHANNEL_JS_HANDLER_REQUEST = "graphene:test:js-handler-request";
    const CHANNEL_JAVA_HANDLER_REQUEST = "graphene:test:java-handler-request";
    const CHANNEL_JAVA_EVENT = "graphene:test:java-event";
    const CHANNEL_JS_ACK_EVENT = "graphene:test:js-ack-event";
    const TEST_NONCE = "graphene-debug-test";

    function sideButtonStatusElement() {
        return document.getElementById("side-button-status");
    }

    function renderSideButton(button, pressed) {
        const action = pressed ? "pressed" : "released";
        sideButtonStatusElement().textContent = "Side button status: button " + button + " " + action;
    }

    function connectMouseBridge() {
        const mouse = globalThis.grapheneMouse;
        if (!mouse || typeof mouse.on !== "function") {
            setTimeout(connectMouseBridge, 50);
            return;
        }

        sideButtonStatusElement().textContent = "Side button status: connected, press a side mouse button";
        mouse.on(function (eventPayload) {
            renderSideButton(Number(eventPayload.button), Boolean(eventPayload.pressed));
        });
    }

    function getBridge() {
        return globalThis.grapheneBridge;
    }

    function connectBridge() {
        const bridge = getBridge();
        if (!bridge || typeof bridge.request !== "function" || typeof bridge.emit !== "function") {
            setTimeout(connectBridge, 50);
            return;
        }

        bridge.handle(CHANNEL_JS_HANDLER_REQUEST, function (payload) {
            return {
                kind: "js-handler-response",
                echoProbe: payload && payload.probe ? payload.probe : null
            };
        });

        bridge.on(CHANNEL_JAVA_EVENT, function () {
            bridge.emit(CHANNEL_JS_ACK_EVENT, {
                stage: "java-event",
                ok: true
            }).catch(function () {
            });
        });

        bridge.emit(CHANNEL_JS_ACK_EVENT, {
            stage: "js-ready",
            ok: true
        }).catch(function () {
        });

        bridge.request(CHANNEL_JAVA_HANDLER_REQUEST, {
            nonce: TEST_NONCE
        }).then(function (responsePayload) {
            bridge.emit(CHANNEL_JS_ACK_EVENT, {
                stage: "java-request",
                ok: true,
                responseKind: responsePayload && responsePayload.kind ? responsePayload.kind : null,
                echoNonce: responsePayload && responsePayload.echoNonce ? responsePayload.echoNonce : null
            }).catch(function () {
            });
        }).catch(function (error) {
            bridge.emit(CHANNEL_JS_ACK_EVENT, {
                stage: "java-request",
                ok: false,
                message: error && error.message ? error.message : String(error)
            }).catch(function () {
            });
        });
    }

    connectMouseBridge();
    connectBridge();
</script>
</body>
</html>
