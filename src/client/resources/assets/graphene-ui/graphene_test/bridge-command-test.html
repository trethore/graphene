<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <title>Graphene Bridge Command Test</title>
</head>
<body>
<script>
    const CHANNEL_JS_HANDLER_REQUEST = "graphene:test:js-handler-request";
    const CHANNEL_JAVA_HANDLER_REQUEST = "graphene:test:java-handler-request";
    const CHANNEL_JAVA_EVENT = "graphene:test:java-event";
    const CHANNEL_JS_ACK_EVENT = "graphene:test:js-ack-event";
    const TEST_NONCE = "graphene-debug-test";

    function getBridge() {
        return globalThis.grapheneBridge;
    }

    function connectBridge() {
        const bridge = getBridge();
        if (!bridge || typeof bridge.request !== "function" || typeof bridge.emit !== "function") {
            setTimeout(connectBridge, 50);
            return;
        }

        bridge.handle(CHANNEL_JS_HANDLER_REQUEST, function (payload) {
            return {
                kind: "js-handler-response",
                echoProbe: payload && payload.probe ? payload.probe : null
            };
        });

        bridge.on(CHANNEL_JAVA_EVENT, function () {
            bridge.emit(CHANNEL_JS_ACK_EVENT, {
                stage: "java-event",
                ok: true
            }).catch(function () {
            });
        });

        bridge.emit(CHANNEL_JS_ACK_EVENT, {
            stage: "js-ready",
            ok: true
        }).catch(function () {
        });

        bridge.request(CHANNEL_JAVA_HANDLER_REQUEST, {
            nonce: TEST_NONCE
        }).then(function (responsePayload) {
            bridge.emit(CHANNEL_JS_ACK_EVENT, {
                stage: "java-request",
                ok: true,
                responseKind: responsePayload && responsePayload.kind ? responsePayload.kind : null,
                echoNonce: responsePayload && responsePayload.echoNonce ? responsePayload.echoNonce : null
            }).catch(function () {
            });
        }).catch(function (error) {
            bridge.emit(CHANNEL_JS_ACK_EVENT, {
                stage: "java-request",
                ok: false,
                message: error && error.message ? error.message : String(error)
            }).catch(function () {
            });
        });
    }

    connectBridge();
</script>
</body>
</html>
